# Send UDP broadcast packets

import socket
MYPORT = 50000

connected = []


def parse_message(data):
    message = data[0].decode('utf-8')
    address = data[1]

    if address[0] != socket.gethostbyname(socket.gethostname()):
        print('Message: ' + message + '\nAddress: ' + address)

    if message == 'connected':
        connected.append(address)
        send_message("data", address)
    elif message.split(' ')[0] == 'Threat:':
        for x in connected:
            if x != address:
                send_message(message, x)
    elif message == 'disconnect':
        connected.remove(address)
        for x in connected:
            send_message('disconnected' + address, address)
    elif message.split(' ')[0] == 'disconnected':
        return
    else:
        return


def send_message(data, address):
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.sendto(data, (address, 0))


def broadcast_server():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.bind(('', MYPORT))
    s.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
    s.setblocking(0)
    print("Server Initialized.")

    while True:
        data = bytes("scan".encode(encoding='utf-8'))
        try:
            s.sendto(data, ('255.255.255.255', MYPORT))
        except socket.error:
            pass
        # print("Sent Packet")
        try:
            m = s.recvfrom(1024)
            parse_message(m)
        except socket.error:
            pass


def broadcast_client():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.bind(('', MYPORT))
    s.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)

    while True:
        try:
            m = s.recvfrom(1024)
            parse_message(m)
        except socket.error:
            pass
